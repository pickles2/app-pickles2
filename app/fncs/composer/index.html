<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>composer - Pickles 2 Desktop Tool</title>

		<meta name="viewport" content="width=device-width" />
		<meta name="keywords" content="" />
		<meta name="description" content="" />

		<!-- jQuery -->
		<script src="../../common/scripts/jquery-1.11.1.min.js" type="text/javascript"></script>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="../../common/bootstrap/css/bootstrap.min.css">
		<script src="../../common/bootstrap/js/bootstrap.min.js"></script>

		<!-- ========== CodeMirror ========== -->
		<link rel="stylesheet" href="../../common/codemirror-4.12/lib/codemirror.css">
		<script src="../../common/codemirror-4.12/lib/codemirror.js"></script>

		<!-- CodeMirror modes -->
		<script src="../../common/codemirror-4.12/mode/xml/xml.js"></script>
		<script src="../../common/codemirror-4.12/mode/javascript/javascript.js"></script>
		<script src="../../common/codemirror-4.12/mode/css/css.js"></script>
		<script src="../../common/codemirror-4.12/mode/htmlmixed/htmlmixed.js"></script>
		<script src="../../common/codemirror-4.12/mode/markdown/markdown.js"></script>

		<!-- CodeMirror addon: foldGutter -->
		<link rel="stylesheet" href="./codemirror-4.12/addon/fold/foldgutter.css" />
		<script src="../../common/codemirror-4.12/addon/fold/foldcode.js"></script>
		<script src="../../common/codemirror-4.12/addon/fold/foldgutter.js"></script>
		<script src="../../common/codemirror-4.12/addon/fold/brace-fold.js"></script>
		<script src="../../common/codemirror-4.12/addon/fold/xml-fold.js"></script>
		<script src="../../common/codemirror-4.12/addon/fold/markdown-fold.js"></script>
		<script src="../../common/codemirror-4.12/addon/fold/comment-fold.js"></script>

		<!-- CodeMirror addon: hints -->
		<link rel="stylesheet" href="../../common/codemirror-4.12/addon/hint/show-hint.css">
		<script src="../../common/codemirror-4.12/addon/hint/show-hint.js"></script>
		<script src="../../common/codemirror-4.12/addon/hint/xml-hint.js"></script>
		<script src="../../common/codemirror-4.12/addon/hint/html-hint.js"></script>
		<script src="../../common/codemirror-4.12/addon/hint/javascript-hint.js"></script>

		<link rel="stylesheet" href="../../common/codemirror-4.12/addon/dialog/dialog.css">
		<script src="../../common/codemirror-4.12/addon/dialog/dialog.js"></script>

		<script src="../../common/codemirror-4.12/addon/search/searchcursor.js"></script>
		<script src="../../common/codemirror-4.12/addon/search/search.js"></script>
		<script src="../../common/codemirror-4.12/addon/edit/matchbrackets.js"></script>
		<script src="../../common/codemirror-4.12/addon/edit/closebrackets.js"></script>
		<script src="../../common/codemirror-4.12/addon/comment/comment.js"></script>
		<script src="../../common/codemirror-4.12/addon/wrap/hardwrap.js"></script>

		<!-- CodeMirror themes: monoaki -->
		<link rel="stylesheet" href="../../common/codemirror-4.12/theme/monokai.css">

		<!-- CodeMirror keymaps: submime -->
		<script src="../../common/codemirror-4.12/keymap/sublime.js"></script>

		<!-- normalize & FESS -->
		<link rel="stylesheet" href="../../common/styles/contents.css" type="text/css" />

		<!-- Local Resources -->
		<link rel="stylesheet" href="./index_files/style.css" type="text/css" />

		<script>
			window.px = $.px = window.parent.px;

			var pj = px.getCurrentProject();
			var cont_pathComposerJson = pj.get('path')+'composer.json';
			var CodeMirrorInstans;
			if( px.utils.isDirectory( pj.get_realpath_composer_root() ) ){
				cont_pathComposerJson = pj.get_realpath_composer_root()+'composer.json';
			}

			function cont_init(){
				px.fs.readFile(cont_pathComposerJson, function(err, src){
					if(err){
						px.message(err);
					}
					$('.cont_edit_composer_json textarea').val(src);
					CodeMirrorInstans = CodeMirror.fromTextArea( $('.cont_edit_composer_json textarea').get(0), {
						lineNumbers: true,
						mode: {name:'javascript', json: true},
						tabSize: 4,
						indentUnit: 4,
						indentWithTabs: true,
						autoCloseBrackets: true,
						matchBrackets: true,
						showCursorWhenSelecting: true,

						foldGutter: true,
						gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],

						theme: 'monokai',
						keyMap: "sublime"
					} );
					CodeMirrorInstans.on('change',function(){
						CodeMirrorInstans.save();
					});
				});

			}

			function cont_update_conposer(btn){
				$(btn).attr('disabled', 'disabled');
				window.px.utils.spawn( px.cmd('composer'),
					['self-update'],
					{
						success: function(data){
							$('.cont_console').text(
								$('.cont_console').text() + data
							);
						} ,
						error: function(data){
							$('.cont_console').text(
								$('.cont_console').text() + data
							);
						} ,
						complete: function(code){
							// $('.cont_console').text(
							// 	$('.cont_console').text() + code
							// );
							$(btn).removeAttr('disabled');
							px.message( 'composer self-update 完了しました。' );
						}
					}
				);
			}

			function cont_update_proj(btn){
				$(btn).attr('disabled', 'disabled');
				window.px.utils.spawn( px.cmd('composer'),
					['update'],
					{
						cd: pj.get_realpath_composer_root(),
						success: function(data){
							$('.cont_console').text(
								$('.cont_console').text() + data
							);
						} ,
						error: function(data){
							$('.cont_console').text(
								$('.cont_console').text() + data
							);
						} ,
						complete: function(code){
							// $('.cont_console').text(
							// 	$('.cont_console').text() + code
							// );
							$(btn).removeAttr('disabled');
							px.message( 'composer update 完了しました。' );
						}
					}
				);
			}

			function cont_install_proj(btn){
				$(btn).attr('disabled', 'disabled');
				window.px.utils.spawn( px.cmd('composer'),
					['install'],
					{
						cd: pj.get_realpath_composer_root(),
						success: function(data){
							$('.cont_console').text(
								$('.cont_console').text() + data
							);
						} ,
						error: function(data){
							$('.cont_console').text(
								$('.cont_console').text() + data
							);
						} ,
						complete: function(code){
							$(btn).removeAttr('disabled');
							px.message( 'composer install 完了しました。' );
						}
					}
				);
			}

			/**
			 * composer.json の編集を保存
			 */
			function cont_save_composerJson(form){
				var $form = $(form);
				var src = $form.find('textarea').val();
				src = JSON.parse( JSON.stringify( src ) );
				px.fs.writeFile( cont_pathComposerJson, src, {encoding:'utf8'}, function(err){
					if(err){
						px.message( 'composer.json の保存に失敗しました。' );
					}else{
						px.message( 'composer.json を保存しました。 $ composer update を実行してください。' );
					}
				} );
			}

			$(function(){
				cont_init();
			});

		</script>
	</head>
	<body>
		<div class="container">
			<h1>Composer</h1>
		</div>
		<div class="contents">
			<div class="container">

				<p><button onclick="cont_update_conposer(this); return false;">composer を更新 (self-update)</button></p>
				<p><button onclick="cont_update_proj(this); return false;">composer プロジェクト を更新 (update)</button></p>
				<p><button onclick="cont_install_proj(this); return false;">composer プロジェクト をインストール (install)</button></p>
				<pre class="cont_console" style="max-height:360px;">console:
</pre>
				<h2>Edit composer.json</h2>
				<form action="javascript:;" method="get" class="cont_edit_composer_json" onsubmit="cont_save_composerJson(this); return false;">
					<textarea></textarea>
					<p><button>composer.json の変更を保存する</button></p>
				</form>
			</div>
		</div>
	</body>
</html>