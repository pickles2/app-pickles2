<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>preview - Pickles 2 Desktop Tool</title>

		<meta name="viewport" content="width=device-width" />
		<meta name="keywords" content="" />
		<meta name="description" content="" />

		<!-- jQuery -->
		<script src="../../common/scripts/jquery-1.11.1.min.js" type="text/javascript"></script>

		<!-- common funcs -->
		<script src="../../common/scripts/common_funcs.js" type="text/javascript"></script>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="../../common/bootstrap/css/bootstrap.min.css">
		<script src="../../common/bootstrap/js/bootstrap.min.js"></script>

		<!-- normalize & FESS -->
		<link rel="stylesheet" href="../../common/styles/contents.css" type="text/css" />
		<script src="../../common/styles/contents.js"></script>

		<!-- Local Resources -->
		<link rel="stylesheet" href="./index_files/style.css" type="text/css" />

		<script>
			window.px = window.parent.px;
			(function(){
				var $preview, $preview_frame;

				function cont_start_preview(){
					px.preview.serverStandby( function(){
						$preview_frame.attr( 'src', px.preview.getUrl() );

						// ↓MEMO: 外部サイトをiframe内に読み込んだ際に任意のコードを実行できるセキュリティ上の課題について考えた時のメモ。
						// - iframe内のコンテンツが unload する前に beforeunload が発生するが、ここでは次のページのURLはわからない。
						// - unload が発生した段階では、もう遷移を中断することはできない。ちなみに、このタイミングでも次のURLはわからない。
						// - 次の画面の onload 時点ではさすがにURLは取得できるが、ロードしたページのコードを実行した後に発生するので、セキュリティ上の問題解決としては不十分。
						$preview_frame.bind('load', function(e){
							console.log('iframe "load" fired.');
							var winIFrame = this.contentWindow;
							console.log( winIFrame.location );
							// $(winIFrame).bind('beforeload', function(e){
							// 	console.log('contentWindow "beforeload" fired.');
							// });
							// $(winIFrame).bind('pageshow', function(e){
							// 	console.log('contentWindow "pageshow" fired.');
							// });
							// $(winIFrame).bind('beforeunload', function(e){
							// 	console.log('contentWindow "beforeunload" fired.');
							// 	console.log( e );
							// 	return 'realy to continue?';
							// });
							// $(winIFrame).bind('unload', function(e){
							// 	console.log('contentWindow "unload" fired.');
							// 	console.log(e);
							// 	console.log(e.target.URL);
							// 	e.preventDefault();
							// 	e.stopPropagation();
							// 	return false;
							// 	return 'realy to continue?';
							// });
							// $(winIFrame).bind('pagehide', function(e){
							// 	console.log('contentWindow "pagehide" fired.');
							// 	console.log(e.target.URL);
							// });
							px.cancelDrop(winIFrame);

						});
						// $preview_frame.bind('unload', function(e){
						// 	console.log('iframe "unload" fired.');
						// });

					} );
				}
				function cont_resize(){
					$preview
						.css({
							'display': 'block',
							'height': $(window).height() - 40
						})
					;
				}
				$(window).load(function(){
					$preview = $('.cont_preview_frame');
					$preview_frame = $preview.find('iframe');

					cont_start_preview();
					$(window).resize();

				});
				$(window).resize(function(){
					cont_resize();
				});

			})();
		</script>
	</head>
	<body>
		<div class="cont_outerframe">
			<div class="preview_window_frame cont_preview_frame"><div class="preview_window_frame--inner">
				<iframe src="about:blank" style="width:100%;"></iframe>
			</div></div>
		</div>
	</body>
</html>
