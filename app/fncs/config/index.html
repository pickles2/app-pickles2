<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Config - Pickles 2 Desktop Tool</title>

		<meta name="viewport" content="width=device-width" />
		<meta name="keywords" content="" />
		<meta name="description" content="" />

		<!-- jQuery -->
		<script src="../../common/scripts/jquery-1.11.1.min.js" type="text/javascript"></script>

		<!-- jQuery UI -->
		<link rel="stylesheet" href="../../common/jquery-ui/jquery-ui.min.css">
		<script src="../../common/jquery-ui/jquery-ui.min.js"></script>

		<!-- jQuery mobile -->
		<link rel="stylesheet" href="../../common/jquery.mobile/jquery.mobile-1.4.5.min.css" />
		<script src="../../common/jquery.mobile/jquery.mobile-1.4.5.min.js"></script>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="../../common/bootstrap/css/bootstrap.min.css">
		<script src="../../common/bootstrap/js/bootstrap.min.js"></script>

		<!-- normalize & FESS -->
		<link rel="stylesheet" href="../../common/styles/contents.css" type="text/css" />

		<!-- Local Resources -->
		<link rel="stylesheet" href="./index_files/style.css" type="text/css" />

		<script>
			window.px = $.px = window.parent.px;
			var pj = px.getCurrentProject();
			var configBasePath = pj.get('path')+'/'+pj.get('home_dir');
			var confPath = configBasePath;
			function cont_init(cb){
				cb = cb||function(){};
				$('.cont_config_json_preview pre').text( JSON.stringify( pj.getConfig() ) );

				var src = '';
				if( px.utils.isFile(configBasePath+'/config.json') ){
					confPath = configBasePath+'/config.json';
				}else if( px.utils.isFile(configBasePath+'/config.php') ){
					confPath = configBasePath+'/config.php';
				}
				src = px.fs.readFileSync(confPath);
				$('.cont_config_edit').html('').append( $('<textarea>').val(src) );
				cb();
			}
			function cont_save( btn ){
				$(btn).attr('disabled', 'disabled');
				var src = $('.cont_config_edit textarea').val();
				src = JSON.parse( JSON.stringify( src ) );

				px.fs.writeFile( confPath, src, {encoding:'utf8'}, function(err){
					cont_init(function(){
						$(btn).removeAttr('disabled');
						px.message( 'コンフィグを保存しました。' );
					});
				} );

			}
			$(function(){
				cont_init();
			});
		</script>
		<style>
			.cont_config_edit textarea{
				width:100%;
				height:24em;
				resize: none;
				overflow: auto;
				color:#999;
				background-color:#000;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Config</h1>
		</div>
		<div class="contents">
			<div class="container">
				<div class="unit">
					<div class="cont_config_edit">
					</div>
					<p><button onclick="cont_save(this); return false;" class="cont_btn_save">保存する</button></p>
				</div>
				<div class="unit cont_config_json_preview">
					<pre></pre>
				</div>
			</div>
		</div>
	</body>
</html>