<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>HOME - Pickles 2 Desktop Tool</title>

		<meta name="viewport" content="width=device-width" />
		<meta name="keywords" content="" />
		<meta name="description" content="" />

		<!-- jQuery -->
		<script src="./common/scripts/jquery-1.11.1.min.js" type="text/javascript"></script>

		<!-- jQuery UI -->
		<link rel="stylesheet" href="./common/jquery-ui/jquery-ui.min.css">
		<script src="./common/jquery-ui/jquery-ui.min.js"></script>

		<!-- jQuery mobile -->
		<link rel="stylesheet" href="./common/jquery.mobile/jquery.mobile-1.4.5.min.css" />
		<script src="./common/jquery.mobile/jquery.mobile-1.4.5.min.js"></script>

		<!-- underscore -->
		<script src="./common/underscore/underscore-min.js" type="text/javascript"></script>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="./common/bootstrap/css/bootstrap.min.css">
		<script src="./common/bootstrap/js/bootstrap.min.js"></script>

		<!-- normalize & FESS -->
		<link rel="stylesheet" href="./common/styles/contents.css" type="text/css" />

		<!-- Local Resources -->
		<link rel="stylesheet" href="./home_files/style.css" type="text/css" />

		<script>
			window.px = $.px = window.parent.px;
			$(function(){
				var pj = px.getCurrentProject();
				var status = pj.status();

				$('.tpl_name').text( pj.get('name') );
				$('.tpl_path').text( pj.get('path') );
				$('.tpl_home_dir').text( pj.get('home_dir') );
				$('.tpl_entry_script').text( pj.get('entry_script') );
				$('.tpl_vcs').text( pj.get('vcs') );

				px.utils.iterate(
					[
						{"title":"PHP version", "cmd": 'php -v'},
						{"title":"PHP path", "cmd": 'which php'},
						{"title":"composer version", "cmd": 'composer --version'},
						{"title":"node version", "cmd": 'node -v'},
						{"title":"git version", "cmd": 'git --version'}
					],
					function(data, idx, it){
						window.px.utils.exec(data.cmd,
							function(err,stdout,stderr){
								$('.tpl_sys_table').append($('<tr>')
									.append($('<th>').text(data.title))
									.append($('<td>')
										.text(stdout)
										.css({"overflow":"auto","white-space":"pre"})
									)
								);
								it.next();
							}
						);
					}
				);

				px.utils.iterate(
					_.keys( status ) ,
					function(data, idx, it){
						$('.tpl_status_table').append($('<tr>')
							.append($('<th>').text(data))
							.append($('<td>')
								.text((status[data]?'true':'false'))
							)
						);
						it.next();
					}
				);

				// インストールボタン
				if( status.pathExists && !status.composerJsonExists ){
					$('.cont_install_ui')
						.html('<p class="center"><button onclick="cont_install(this); return false;">Pickles 2 をインストールする</button></p>')
					;
				}

			});

			/**
			 * Pickles2 インストール
			 */
			function cont_install(btn){
				$(btn).attr('disabled','disabled');
				var pj = px.getCurrentProject();
				window.px.utils.spawn('composer',
					[
						'create-project',
						'tomk79/pickles2',
						'./',
						'dev-master'
					],
					{
						cd: pj.get('path'),
						success: function(data){
						} ,
						error: function(data){
							alert('ERROR: '+data);
						} ,
						complete: function(code){
							$(btn).removeAttr('disabled');
							px.subapp('home.html');
						}
					}
				);
			}
		</script>
	</head>
	<body style="background-color:#eee;">
		<div class="contents">
			<div class="container">
				<h1 class="tpl_name">...</h1>
				<div class="unit">
					<table class="def" style="width:100%; table-layout: fixed;">
						<colgroup><col width="30%" /><col width="70%" /></colgroup>
						<tr>
							<th>Name</th>
							<td class="tpl_name">...</td>
						</tr>
						<tr>
							<th>Path</th>
							<td class="tpl_path">...</td>
						</tr>
						<tr>
							<th>HOME Directory</th>
							<td class="tpl_home_dir">...</td>
						</tr>
						<tr>
							<th>Entry script</th>
							<td class="tpl_entry_script">...</td>
						</tr>
						<tr>
							<th>VCS</th>
							<td class="tpl_vcs">...</td>
						</tr>
					</table>
				</div><!-- /.unit -->

				<div class="unit">
					<h2>Status</h2>
					<table class="def tpl_status_table" style="width:100%; table-layout: fixed;">
						<colgroup><col width="30%" /><col width="70%" /></colgroup>
					</table>
					<div class="cont_install_ui"></div>
				</div><!-- /.unit -->

				<div class="unit">
					<h2>System info</h2>
					<table class="def tpl_sys_table" style="width:100%; table-layout: fixed;">
						<colgroup><col width="30%" /><col width="70%" /></colgroup>
					</table>
				</div><!-- /.unit -->

				<p><button onclick="px.deselectProject(); px.subapp(); return false;">プロジェクト選択へ戻る</button></p>
				<p><button onclick="if(confirm('このプロジェクトを削除してよろしいですか？')){px.deleteProject( px.getCurrentProject().projectId );} return false;">このプロジェクトを削除</button></p>

			</div>
		</div>
	</body>
</html>